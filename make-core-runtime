#!/usr/bin/env bash

set -euo pipefail

export SILVER_HOME=$PWD
JVM_ARGS=(-Xss20M -Xmx1G -jar ../jars/silver.compiler.composed.Default.jar --no-stdlib "$@")
export GRAMMAR_PATH="../grammars"
export ANT_OPTS=-Xss10M

mkdir -p build
cd build

echo    "=== BUILD CORE JAVA SOURCES ==="
time java "${JVM_ARGS[@]}" silver:core silver:xml:ast

# Note that the runtime sources must be compiled with core, so we use the build
# file in runtime/java instead of the one generated by silver.

echo    "=== BUILD CORE AND RUNTIME ==="
cd ../runtime/java
ant
mv silver.core.jar ../../build
cd ../../build

if [ -z "${NOINSTALL:-}" ]; then
    echo    "=== INSTALL NEW CORE/RUNTIME ==="
    mv silver.core.jar ../jars
fi
