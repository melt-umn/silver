#!/bin/bash

set -eu

# Usage: ./fetch-jars [rev-name] [--copper]


if [[ $* != *--copper* && $# -gt 0 || $# -gt 1 ]]; then
    rev=$(git rev-parse $1)
    echo "Warning: Fetching unstable jars!  (commit $rev)"

    LOCAL_STORE=
    REMOTE_STORE="https://foundry.remexre.xyz/commit-artifacts/$rev"
    JARS_BAK="JARS-BAK/$rev"
else
    LOCAL_STORE=/web/research/melt.cs.umn.edu/downloads/silver-dev/jars
    REMOTE_STORE="https://melt.cs.umn.edu/downloads/silver-dev/jars"
    JARS_BAK=JARS-BAK
fi

if [[ $* == *--copper* ]]; then
    # Only fetch the Copper jars, if requested
    FILES="CopperCompiler.jar"
else
    FILES="CopperCompiler.jar commonmark-0.17.1.jar silver.compiler.composed.Default.jar SilverRuntime.jar IDEPluginRuntime.jar"
fi

mkdir -p jars

if [[ -n "$LOCAL_STORE" && -d $LOCAL_STORE ]]; then
  for file in $FILES; do
      cp $LOCAL_STORE/$file jars/
  done
else
  # There's probably a better way to do this!
  # Using -r causes lots of pointless downloads of variations of the index.html
  # even if -A.jar is used they still get downloaded...
  
  URLS=""
  for file in $FILES; do
    URLS="$URLS $REMOTE_STORE/$file"
  done
  
  # We're going to download them to here
  mkdir -p $JARS_BAK
  
  # -N Pay attention to timestamps, to avoid needless redownloads.
  # -P jars/  Put the files in jars/
  # -nv Don't be so verbose!
  wget -N -P $JARS_BAK/ -nv $URLS
  
  # Always overwrite all the files in jars.
  for file in $FILES; do
      cp $JARS_BAK/$file jars/
  done
fi

