#!/bin/bash

set -eu

if [ ! -d grammars ] ; then
  echo "Wrong directory? Run as ./update"
  exit 1
fi

echo " -- Updating git checkout"
git pull

echo " -- Updating jar files"
./support/scripts/fetch-jars

mkdir -p generated

if [ -d generated/src ]; then
  echo " -- Deleting old generated file cache"
  for file in generated/*/*; do
    echo $file
    rm -rf $file
  done
fi

if [ -d /export/scratch ] && [ ! -d generated/src ]; then
  echo " -- Creating initial generated cache symlinks to local disk"
  CACHE=/export/scratch/${USER}-deletable-cache
  mkdir -p ${CACHE}
  if [ ! -O ${CACHE} ]; then
    echo "ERROR: You do not own your own generated cache!"
    ls -la /export/scratch
    exit 1
  fi
  for dir in bin src ide doc; do
    echo ${CACHE}/${dir}
    mkdir -p ${CACHE}/${dir}
    ln -s ${CACHE}/${dir} generated/${dir}
  done
fi

echo " -- Done"

if [ $(git symbolic-ref -q HEAD) != "refs/heads/develop" ]; then
  echo " -- REMINDER: You do not currently have 'develop' checked out. git branch:"
  git branch
fi

